<script>
function initializeEnquiryFeature() {

    // --- FUNCTION TO GET ALL PRODUCT DATA FROM THE CART ---
    const sendToBackend = () => {
        try {
            // Get the main store object
            const store = window.wp.data.select('wc/store/cart');
            
            // Let's inspect this object in the console to see what's available
            // console.log('Inspecting the WooCommerce store object:', store);

            // The correct method is likely getCartData(), which contains an 'items' array.
            const cartData = store.getCartData();
            const cartItems = cartData.items;

            if (!cartItems || cartItems.length === 0) {
                console.log('No items found in the cart.');
                return;
            }

            // Extract just the product IDs and quantities into a simpler array
            const productData = cartItems.map(item => {
                return {
                    id: item.id,
                    name: item.name,
                    quantity: item.quantity
                };
            });
            
            // Print the final, extracted data to the browser's console
            //console.log('--- Cart Product Data ---');
            console.log(productData);
            
            // This is where you would send the 'productData' to your backend
            
        } catch (error) {
            console.error('An error occurred while fetching cart data:', error);
            alert('Could not retrieve cart items. Please try again.');
        }
    };


    // --- PART 1: ADD THE BUTTON TO THE PAGE ---

    const addEnquiryButton = () => {
        const checkoutButtonContainer = document.querySelector('.wc-block-cart__submit-container');
        const enquiryButtonExists = document.getElementById('send-enquiry-btn');

        if (checkoutButtonContainer && !enquiryButtonExists) {
            const originalButton = checkoutButtonContainer.querySelector('a');
            if (!originalButton) return; 
            
            const enquiryButton = originalButton.cloneNode(true);
            enquiryButton.id = 'send-enquiry-btn';
            enquiryButton.querySelector('.wc-block-components-button__text').textContent = 'Send Enquiry';
            enquiryButton.href = '#';
            
            const newButtonContainer = document.createElement('div');
            newButtonContainer.className = 'wc-block-cart__submit-container';
            newButtonContainer.style.marginTop = '10px';
            newButtonContainer.appendChild(enquiryButton);
            
            checkoutButtonContainer.parentNode.insertBefore(newButtonContainer, checkoutButtonContainer.nextSibling);

            setupPopupLogic();
        }
    };


    // --- PART 2: HANDLE THE POPUP LOGIC ---

    const setupPopupLogic = () => {
        const enquiryBtn = document.getElementById('send-enquiry-btn');
        const popupOverlay = document.getElementById('enquiry-popup-overlay');
        const closePopupBtn = document.getElementById('close-popup-btn');
        const enquiryForm = document.getElementById('enquiry-form');

        if (enquiryBtn) {
            enquiryBtn.addEventListener('click', function(e) {
                e.preventDefault();
                popupOverlay.style.display = 'flex';
            });
        }

        function closePopup() {
            popupOverlay.style.display = 'none';
        }

        if (closePopupBtn) {
            closePopupBtn.addEventListener('click', closePopup);
        }

        if (popupOverlay) {
            popupOverlay.addEventListener('click', function(e) {
                if (e.target === popupOverlay) {
                    closePopup();
                }
            });
        }

        if (enquiryForm) {
            enquiryForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                sendToBackend();
                
                alert('Thank you! Your enquiry has been sent. Check the console to see the product data.');
                
                closePopup();
                enquiryForm.reset();
            });
        }
    };
    
    const cartCheck = setInterval(function() {
        if (document.querySelector('.wc-block-cart__submit-container')) {
             clearInterval(cartCheck);
             addEnquiryButton(); 
        }
    }, 500); 
}


const readyCheck = setInterval(function() {
    if (window.wp && window.wp.data && window.wp.data.select('wc/store/cart')) {
        clearInterval(readyCheck); 
        initializeEnquiryFeature();
    }
}, 100); 
</script>
