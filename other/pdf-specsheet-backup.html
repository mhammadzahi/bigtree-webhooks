<style>
    #unique-enquiry-popup-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); z-index: 99999; justify-content: center;
        align-items: center; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    #unique-enquiry-popup-content {
        background: #fff; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px;
        position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center;
    }
    #unique-enquiry-popup-content p { font-size: 16px; margin-bottom: 20px; }
    #unique-enquiry-popup-content input[type="email"] {
        width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc;
        border-radius: 4px; box-sizing: border-box;
    }
    #unique-enquiry-popup-content button[type="submit"] {
        width: 100%; cursor: pointer; background-color: #532A44; color: #fff; border: none;
        padding: 12px; font-size: 16px; border-radius: 4px; transition: opacity 0.2s;
    }
    #unique-enquiry-popup-content button[type="submit"]:hover { opacity: 0.9; }
    #unique-close-popup-btn {
        position: absolute; top: 10px; right: 15px; background: transparent; border: none;
        font-size: 28px; cursor: pointer; color: #333; padding: 0; line-height: 1;
    }
</style>

<div id="unique-enquiry-popup-overlay">
    <div id="unique-enquiry-popup-content">
        <p>Enter your email and we'll send you the specsheet</p>
        <form id="unique-enquiry-form">
            <input type="hidden" id="unique-target-product-id" value="">
            <input type="email" id="unique-enquiry-email" name="enquiry_email" placeholder="Enter your email" required>
            <button type="submit">Send</button>
        </form>
        <button id="unique-close-popup-btn" title="Close">&times;</button>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async function () {
  // --- Variable to hold the user's email ---
  let loggedInUserEmail = '';

  // --- NEW: Fetch user email via AJAX on page load ---
  async function fetchUserEmail() {
    try {
      const formData = new URLSearchParams();
      formData.append('action', 'get_logged_in_user_email'); // This is the action name from our PHP

      const response = await fetch(my_ajax_obj.ajax_url, {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
          throw new Error('Network response was not ok.');
      }

      const result = await response.json();
      if (result.success && result.data.email) {
        loggedInUserEmail = result.data.email;
        console.log('Logged-in user email fetched:', loggedInUserEmail);
      }
    } catch (error) {
      console.error('Failed to fetch user email:', error);
    }
  }

  // Call the function to get the email as soon as the page is ready
  await fetchUserEmail();

  // --- Popup Elements ---
  const enquiryPopupOverlay = document.getElementById("unique-enquiry-popup-overlay");
  const enquiryForm = document.getElementById("unique-enquiry-form");
  const closePopupBtn = document.getElementById("unique-close-popup-btn");
  const targetProductIdInput = document.getElementById("unique-target-product-id");
  const enquiryEmailInput = document.getElementById("unique-enquiry-email");
  const specsheetDivs = document.querySelectorAll(".download-specsheet-btn");

  // --- SweetAlert2 Toast Configuration (No Changes) ---
  const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 3500,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.addEventListener('mouseenter', Swal.stopTimer)
      toast.addEventListener('mouseleave', Swal.resumeTimer)
    }
  });

  // --- Show Popup on Button Click ---
  specsheetDivs.forEach(div => {
    const anchor = div.querySelector("a[id]");
    if (anchor) {
      anchor.addEventListener("click", function(event) {
        event.preventDefault();
        const productId = this.id;
        console.log("Clicked Spec Sheet ID:", productId);
        
        targetProductIdInput.value = productId;
        
        // **MODIFICATION**: Use the email we fetched via AJAX
        if (loggedInUserEmail) {
            enquiryEmailInput.value = loggedInUserEmail;
        }

        enquiryPopupOverlay.style.display = 'flex';
      });
    }
  });

  // --- Handle Form Submission (No Changes) ---
  enquiryForm.addEventListener("submit", async function(event) {
    event.preventDefault();
    const productId = targetProductIdInput.value;
    const email = enquiryEmailInput.value;

    if (!email) {
      Toast.fire({ icon: 'warning', title: 'Please enter your email address' });
      return;
    }

    enquiryPopupOverlay.style.display = 'none';
    Swal.fire({ title: 'Sending Request...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    try {
      const response = await fetch("https://app.bigtree-group.com/bt-single-product-specsheet-webhook-v2-1", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-API-Key": window.MySiteSettings.apiKey },
        body: JSON.stringify({ product_id: productId, email: email})
      });
      if (!response.ok) { throw new Error("Network response was not ok"); }
      Swal.close(); 
      Toast.fire({ icon: 'success', title: 'Request sent! Please check your email.' });
    } catch (error) {
      Swal.close();
      console.error("Error processing request:", error);
      Toast.fire({ icon: 'error', title: 'Something went wrong! Please try again.' });
    } finally {
        enquiryForm.reset();
    }
  });

  // --- Close Popup Functionality (No Changes) ---
  function closePopup() {
    enquiryPopupOverlay.style.display = 'none';
    enquiryForm.reset();
  }
  closePopupBtn.addEventListener("click", closePopup);
  enquiryPopupOverlay.addEventListener("click", function(event) {
    if (event.target === enquiryPopupOverlay) {
      closePopup();
    }
  });
});
</script>